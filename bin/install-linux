#!/bin/bash
#
# Linux/WSL2 Dotfiles Installer

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

step() { echo ""; echo -e "${BLUE}-->$NC $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[X]${NC} $1"; exit 1; }

# Detect WSL
IS_WSL=false
if grep -qi microsoft /proc/version 2>/dev/null; then
    IS_WSL=true
fi

echo ""
step "Linux/WSL2 Dotfiles Installer"
echo ""
if [ "$IS_WSL" = true ]; then
    echo "  Detected: WSL2 environment"
else
    echo "  Detected: Native Linux environment"
fi
echo ""
warn "This will install/update your terminal setup"
echo ""
read -p "Continue? (y/n) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    step "Cancelled"
    exit 0
fi

echo ""
sudo -v

# Suppress login message
touch ~/.hushlogin

# APT packages
step "Installing APT packages"
bash ~/.dotfiles/linux/apt-packages.sh
success "APT packages installed"

# System defaults (inotify, swappiness, etc.)
step "Configuring system defaults"
bash ~/.dotfiles/linux/set-defaults.sh
success "System defaults configured"

# Oh My Zsh
step "Installing Oh My Zsh"
if [ ! -d ~/.oh-my-zsh ]; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || warn "Oh My Zsh installation failed"
fi
success "Oh My Zsh installed"

# Git configuration
step "Configuring Git"
ln -sf ~/.dotfiles/home/.gitconfig ~/.gitconfig
ln -sf ~/.dotfiles/home/.global-gitignore ~/.global-gitignore
success "Git configured"

# Symlinks
step "Creating symlinks"
rm -f ~/.zshrc ~/.vimrc ~/.vim

ln -sf ~/.dotfiles/home/.zshrc ~/.zshrc
ln -sf ~/.dotfiles/home/.vimrc ~/.vimrc
ln -sf ~/.dotfiles/home/.vim ~/.vim

# CLI tool configs
ln -sf ~/.dotfiles/home/.ripgreprc ~/.ripgreprc
ln -sf ~/.dotfiles/home/.fdignore ~/.fdignore

mkdir -p ~/.config/bat
ln -sf ~/.dotfiles/config/bat/config ~/.config/bat/config

# Atuin shell history
mkdir -p ~/.config/atuin
ln -sf ~/.dotfiles/config/atuin/config.toml ~/.config/atuin/config.toml

# Neovim config (LazyVim)
mkdir -p ~/.config/nvim
ln -sf ~/.dotfiles/config/nvim/init.lua ~/.config/nvim/init.lua
ln -sf ~/.dotfiles/config/nvim/lua ~/.config/nvim/lua

# Starship prompt config
if command -v starship &> /dev/null; then
    mkdir -p ~/.config
    if [ -f ~/.dotfiles/config/starship.toml ]; then
        ln -sf ~/.dotfiles/config/starship.toml ~/.config/starship.toml
    fi
fi

# Lazygit config
mkdir -p ~/.config/lazygit
ln -sf ~/.dotfiles/config/lazygit/config.yml ~/.config/lazygit/config.yml

# Lazydocker config
mkdir -p ~/.config/lazydocker
ln -sf ~/.dotfiles/config/lazydocker/config.yml ~/.config/lazydocker/config.yml

# Yazi file manager config
mkdir -p ~/.config/yazi
ln -sf ~/.dotfiles/config/yazi/yazi.toml ~/.config/yazi/yazi.toml
ln -sf ~/.dotfiles/config/yazi/keymap.toml ~/.config/yazi/keymap.toml
ln -sf ~/.dotfiles/config/yazi/theme.toml ~/.config/yazi/theme.toml

# Zellij terminal multiplexer
mkdir -p ~/.config/zellij/layouts
ln -sf ~/.dotfiles/config/zellij/config.kdl ~/.config/zellij/config.kdl
ln -sf ~/.dotfiles/config/zellij/layouts/laravel-dev.kdl ~/.config/zellij/layouts/laravel-dev.kdl

# mise version manager
mkdir -p ~/.config/mise
ln -sf ~/.dotfiles/config/mise/config.toml ~/.config/mise/config.toml

# Git hooks (gitleaks, conventional commits)
mkdir -p ~/.config/git/hooks
ln -sf ~/.dotfiles/config/git/hooks/pre-commit ~/.config/git/hooks/pre-commit
ln -sf ~/.dotfiles/config/git/hooks/commit-msg ~/.config/git/hooks/commit-msg

# SSH config
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ln -sf ~/.dotfiles/home/.ssh_config ~/.ssh/config
chmod 600 ~/.ssh/config

success "Symlinks created"

# WSL-specific setup
if [ "$IS_WSL" = true ]; then
    step "Configuring WSL2"

    # Install wsl.conf
    if [ -f ~/.dotfiles/windows/wsl.conf ]; then
        sudo cp ~/.dotfiles/windows/wsl.conf /etc/wsl.conf
        success "wsl.conf installed"
        warn "Restart WSL for changes: wsl --shutdown"
    fi

    # Remind about .wslconfig
    echo ""
    echo "  To configure WSL2 resources, copy .wslconfig to Windows:"
    echo "  cp ~/.dotfiles/windows/.wslconfig /mnt/c/Users/\$USER/.wslconfig"
fi

# NPM setup
step "Configuring npm"
mkdir -p ~/.npm-packages
if command -v npm &> /dev/null; then
    npm config set prefix ~/.npm-packages || warn "npm config failed"
fi
success "npm configured"

# mise - unified version manager
step "Setting up mise"
if command -v mise &> /dev/null; then
    eval "$(mise activate bash)"
    mise install || warn "mise install failed"
    success "mise configured (manages Node.js, Python, Ruby, Go, etc.)"
else
    warn "mise not found - run apt-packages.sh first"
fi

# PHP/Composer
echo ""
read -p "Install PHP/Composer? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash ~/.dotfiles/linux/setup-php.sh
    success "PHP/Composer installed"
else
    warn "Skipping PHP/Composer"
fi

# MySQL
echo ""
read -p "Install MySQL? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash ~/.dotfiles/linux/setup-mysql.sh
    success "MySQL installed"
else
    warn "Skipping MySQL"
fi

# Claude Code
echo ""
read -p "Install Claude Code? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if command -v npm &> /dev/null; then
        npm install -g @anthropic-ai/claude-code || warn "Claude Code installation failed"
        success "Claude Code installed"
    else
        warn "npm not found - install Node.js first"
    fi
else
    warn "Skipping Claude Code"
fi

# Configure global git hooks
step "Configuring git hooks"
if [ -d ~/.config/git/hooks ]; then
    git config --global core.hooksPath ~/.config/git/hooks
    success "Git hooks configured (gitleaks + conventional commits)"
else
    warn "Git hooks directory not found"
fi

# Change default shell to zsh
step "Setting zsh as default shell"
if [ "$SHELL" != "$(which zsh)" ]; then
    chsh -s $(which zsh) || warn "Could not change default shell"
    success "Default shell changed to zsh"
else
    success "zsh is already default shell"
fi

# Done
echo ""
success "Installation complete!"
echo ""
step "Next steps:"
echo "  - Log out and back in (or run 'exec zsh') to use new shell"
echo "  - Run 'nvim' to bootstrap LazyVim plugins"
echo "  - Run 'atuin register' or 'atuin login' for shell history sync"
echo ""

if [ "$IS_WSL" = true ]; then
    echo "WSL2 specific:"
    echo "  - Copy .wslconfig to Windows: cp ~/.dotfiles/windows/.wslconfig /mnt/c/Users/\$USER/.wslconfig"
    echo "  - Run 'wsl --shutdown' from PowerShell to apply wsl.conf changes"
    echo "  - Install Windows Terminal and import settings from ~/.dotfiles/windows/terminal/"
    echo ""
fi

echo "Zellij (terminal multiplexer):"
echo "  - Run 'zellij' to start"
echo "  - Laravel dev layout: zellij --layout ~/.config/zellij/layouts/laravel-dev.kdl"
echo ""
echo "mise (version manager):"
echo "  - Run 'mise install node@lts' to install Node.js"
echo "  - Run 'mise use node@lts' to set default"
echo ""
echo "Laravel projects:"
echo "  - Copy config/laravel/* to your project root"
echo "  - Add composer scripts from config/laravel/composer-scripts.json"
echo ""
