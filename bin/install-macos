#!/bin/bash
#
# macOS Dotfiles Installer

set -e

# Colors
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

step() { echo ""; echo -e "${BLUE}-->$NC $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[X]${NC} $1"; exit 1; }

echo ""
step "macOS Dotfiles Installer"
echo ""
warn "This will install/update your terminal setup"
echo ""
read -p "Continue? (y/n) " -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo ""
    step "Cancelled"
    echo ""
    exit 0
fi

echo ""
sudo -v

# Start
touch ~/.hushlogin

step "Installing Oh My Zsh"
if [ ! -d ~/.oh-my-zsh ]; then
    rm -rf ~/.oh-my-zsh
    curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh -s -- --unattended || warn "Oh My Zsh installation failed"
fi
success "Oh My Zsh installed"

# Git configuration
step "Configuring Git"
ln -sf ~/.dotfiles/home/.gitconfig ~/.gitconfig
ln -sf ~/.dotfiles/home/.global-gitignore ~/.global-gitignore
success "Git configured"

# Symlinks
step "Creating symlinks"
rm -f ~/.zshrc ~/.vimrc ~/.vim ~/.mackup.cfg
ln -sf ~/.dotfiles/home/.zshrc ~/.zshrc
ln -sf ~/.dotfiles/home/.vimrc ~/.vimrc
ln -sf ~/.dotfiles/home/.vim ~/.vim
ln -sf ~/.dotfiles/macos/.mackup.cfg ~/.mackup.cfg

# Ghostty terminal config
mkdir -p ~/.config/ghostty
ln -sf ~/.dotfiles/config/ghostty/config ~/.config/ghostty/config

# Neovim config (LazyVim)
mkdir -p ~/.config/nvim
ln -sf ~/.dotfiles/config/nvim/init.lua ~/.config/nvim/init.lua
ln -sf ~/.dotfiles/config/nvim/lua ~/.config/nvim/lua

# CLI tool configs
ln -sf ~/.dotfiles/home/.ripgreprc ~/.ripgreprc
ln -sf ~/.dotfiles/home/.fdignore ~/.fdignore
mkdir -p ~/.config/bat
ln -sf ~/.dotfiles/config/bat/config ~/.config/bat/config

# Starship prompt config
ln -sf ~/.dotfiles/config/starship.toml ~/.config/starship.toml

# Atuin shell history
mkdir -p ~/.config/atuin
ln -sf ~/.dotfiles/config/atuin/config.toml ~/.config/atuin/config.toml

# Lazygit config
mkdir -p ~/.config/lazygit
ln -sf ~/.dotfiles/config/lazygit/config.yml ~/.config/lazygit/config.yml

# Lazydocker config
mkdir -p ~/.config/lazydocker
ln -sf ~/.dotfiles/config/lazydocker/config.yml ~/.config/lazydocker/config.yml

# Yazi file manager config
mkdir -p ~/.config/yazi
ln -sf ~/.dotfiles/config/yazi/yazi.toml ~/.config/yazi/yazi.toml
ln -sf ~/.dotfiles/config/yazi/keymap.toml ~/.config/yazi/keymap.toml
ln -sf ~/.dotfiles/config/yazi/theme.toml ~/.config/yazi/theme.toml

# Zellij terminal multiplexer
mkdir -p ~/.config/zellij/layouts
ln -sf ~/.dotfiles/config/zellij/config.kdl ~/.config/zellij/config.kdl
ln -sf ~/.dotfiles/config/zellij/layouts/laravel-dev.kdl ~/.config/zellij/layouts/laravel-dev.kdl

# mise version manager
mkdir -p ~/.config/mise
ln -sf ~/.dotfiles/config/mise/config.toml ~/.config/mise/config.toml

# Git hooks (gitleaks, conventional commits)
mkdir -p ~/.config/git/hooks
ln -sf ~/.dotfiles/config/git/hooks/pre-commit ~/.config/git/hooks/pre-commit
ln -sf ~/.dotfiles/config/git/hooks/commit-msg ~/.config/git/hooks/commit-msg

# SSH config
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ln -sf ~/.dotfiles/home/.ssh_config ~/.ssh/config
chmod 600 ~/.ssh/config

success "Symlinks created"

# NPM setup
step "Configuring npm"

# Fix npm permission issues (EACCES error)
for npm_dir in ~/.npm ~/.npm-packages; do
    if [ -d "$npm_dir" ]; then
        sudo chown -R $(id -u):$(id -g) "$npm_dir"
    fi
done
if [ -f ~/.npmrc ]; then
    sudo chown $(id -u):$(id -g) ~/.npmrc
fi

mkdir -p ~/.npm-packages
npm config set prefix ~/.npm-packages || warn "npm config failed"
success "npm configured"

# Homebrew
step "Installing Homebrew"
if ! command -v brew &>/dev/null; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
success "Homebrew installed"

# Install all packages from Brewfile
step "Installing packages from Brewfile"
brew bundle --file=~/.dotfiles/config/Brewfile || warn "Some packages failed (likely already installed)"
success "Brewfile processed"

# mise - unified version manager
step "Setting up mise"
if command -v mise &>/dev/null; then
    eval "$(mise activate bash)" || warn "mise activation failed"
    mise install || warn "mise install failed"
    success "mise configured (manages Node.js, Python, Ruby, Go, etc.)"
else
    warn "mise not found - run 'brew install mise' first"
fi

# Laravel Herd
step "Checking Laravel Herd"
if command -v herd &>/dev/null; then
    success "Laravel Herd is installed"
    echo "  PHP extensions (imagick, redis, xdebug) can be managed via Herd UI"
else
    warn "Laravel Herd not found"
    echo "  Install Herd from: https://herd.laravel.com"
    echo "  Herd manages PHP, Composer, and extensions automatically"
fi

# Global npm packages
step "Installing global npm packages"
npm install -g agent-browser || warn "agent-browser already installed or failed"
agent-browser install 2>/dev/null || warn "agent-browser setup skipped"
success "npm packages processed"

# Global Composer packages
step "Installing global Composer packages"
composer global require laravel/envoy || warn "envoy already installed or failed"
composer global require spatie/phpunit-watcher || warn "phpunit-watcher already installed or failed"
success "Composer packages processed"

# MySQL
step "Starting MySQL"
brew services start mysql || warn "MySQL already running or failed"
success "MySQL processed"

# macOS defaults
echo ""
read -p "Configure macOS defaults? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash ~/.dotfiles/macos/set-defaults.sh || warn "macOS defaults had issues"
else
    warn "Skipping macOS defaults"
fi

# Claude Code setup
echo ""
read -p "Install Claude Code? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    bash ~/.dotfiles/bin/install-claude-code || warn "Claude Code setup had issues"
else
    warn "Skipping Claude Code installation"
fi

# Initialize Atuin (shell history)
step "Setting up Atuin"
if command -v atuin &>/dev/null; then
    echo "  Run 'atuin register' or 'atuin login' to enable sync"
    success "Atuin installed"
else
    warn "Atuin not found - run 'brew install atuin' first"
fi

# Configure global git hooks
step "Configuring git hooks"
if [ -d ~/.config/git/hooks ]; then
    git config --global core.hooksPath ~/.config/git/hooks
    success "Git hooks configured (gitleaks + conventional commits)"
else
    warn "Git hooks directory not found"
fi

# Done
echo ""
success "Installation complete!"
echo ""
step "Next steps:"
echo "  - Open Ghostty terminal (already configured)"
echo "  - Restore settings: mackup restore (if you have backups)"
echo "  - Customize aliases: ~/.dotfiles-custom/shell/.aliases"
echo ""
echo "Neovim (LazyVim):"
echo "  - Open nvim to bootstrap LazyVim plugins"
echo "  - Run :checkhealth to verify LSP/treesitter"
echo ""
echo "Atuin (shell history sync):"
echo "  - Run 'atuin register' to create account"
echo "  - Or 'atuin login' if you have existing account"
echo ""
echo "Zellij (terminal multiplexer):"
echo "  - Run 'zellij' to start"
echo "  - Laravel dev layout: zellij --layout ~/.config/zellij/layouts/laravel-dev.kdl"
echo ""
echo "mise (version manager):"
echo "  - Run 'mise install node@lts' to install Node.js"
echo "  - Run 'mise use node@lts' to set default"
echo "  - Add .mise.toml to projects for per-project versions"
echo ""
echo "Laravel projects:"
echo "  - Copy config/laravel/* to your project root"
echo "  - Add composer scripts from config/laravel/composer-scripts.json"
echo ""
echo "Optional:"
echo "  - Run 'just check' to verify tool installations"
echo "  - Discover more agent skills: https://skills.sh"
echo ""
